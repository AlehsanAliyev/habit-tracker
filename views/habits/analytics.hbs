<div class="page-head">
  <div>
    <h1>Analytics</h1>
    <p class="page-subtitle">Past {{range}} days overview.</p>
  </div>
  <div class="page-actions">
    <a class="btn ghost" href="/habits">Back to Dashboard</a>
  </div>
</div>

<div class="card">
  <form method="GET" action="/habits/analytics" class="form-row">
    <div class="form-field">
      <label for="range">Range</label>
      <select class="select" name="range" id="range" onchange="this.form.submit()">
        <option value="7" {{#ifEquals range 7}}selected{{/ifEquals}}>Past 7 Days</option>
        <option value="30" {{#ifEquals range 30}}selected{{/ifEquals}}>Past 30 Days</option>
      </select>
    </div>

    <div class="form-field">
      <label for="sort">Sort by</label>
      <select class="select" name="sort" id="sort" onchange="this.form.submit()">
        <option value="completion">Completion %</option>
        <option value="average">Avg. Score</option>
        <option value="streak">Streak</option>
      </select>
    </div>
  </form>

  <div class="meta-chips">
    {{#if bestHabit}}
      <span class="badge success">Best: {{bestHabit.title}}</span>
    {{/if}}
    {{#if worstHabit}}
      <span class="badge warn">Needs focus: {{worstHabit.title}}</span>
    {{/if}}
  </div>
</div>

{{#if analytics.length}}
  <div class="card section-spacer">
    <div class="card-head">
      <h2 class="card-title">Completion Overview</h2>
      <p class="card-meta">Percent complete by habit.</p>
    </div>
    <div class="chart-wrap">
      <canvas id="completionChart" class="chart-canvas"></canvas>
    </div>
  </div>

  <div class="card-grid section-spacer">
    {{#each analytics}}
      <div class="card habit-card">
        <div class="habit-head">
          <h3 class="habit-title">{{title}}</h3>
          <span class="pill">{{frequency}}</span>
        </div>

        <div class="habit-meta">
          <div class="meta-line"><strong>Completion:</strong> {{percentage}}%</div>
          <div class="meta-line"><strong>Avg. score:</strong> {{averageScore}} / 2</div>
        {{#if (gt streak 0)}}
          <div class="meta-line">
            <strong>Activity streak:</strong> {{streak}} day{{#if (gt streak 1)}}s{{/if}}
          </div>
        {{/if}}
        {{#if (gt doneStreak 0)}}
          <div class="meta-line">
            <strong>Done streak:</strong> {{doneStreak}} day{{#if (gt doneStreak 1)}}s{{/if}}
          </div>
        {{/if}}
          {{#if badge}}
            <div class="meta-line"><span class="badge success">{{badge}}</span></div>
          {{/if}}
        </div>

        <div class="habit-spacer"></div>

        <div class="heatmap" aria-label="Last seven days">
          {{#each heatmap}}
            <span class="heatmap-square {{#if (eq score 2)}}is-good{{else if (eq score 1)}}is-warn{{else if (eq score 0)}}is-bad{{else if (eq score 'f')}}is-muted{{else}}is-empty{{/if}}"></span>
          {{/each}}
        </div>

        {{#if ../rangeIs30}}
          <canvas class="sparkline" data-labels="{{scoreTrendLabels}}" data-values="{{scoreTrendValues}}"></canvas>
        {{/if}}
      </div>
    {{/each}}
  </div>

  <script>
    Chart.defaults.font.family = '"Space Grotesk", "Segoe UI", system-ui, sans-serif';
    Chart.defaults.color = 'rgba(255,255,255,.78)';

    const chartLabels = {{{labels}}};
    const wrapLabel = (label) => {
      if (!label) return '';
      const maxChars = 18;
      if (label.length <= maxChars) return label;
      const words = label.split(' ');
      const lines = [];
      let current = '';
      words.forEach((word) => {
        const next = current ? `${current} ${word}` : word;
        if (next.length > maxChars) {
          if (current) lines.push(current);
          current = word;
        } else {
          current = next;
        }
      });
      if (current) lines.push(current);
      return lines.length ? lines : label;
    };

    const ctx = document.getElementById('completionChart').getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: chartLabels,
        datasets: [{
          label: 'Completion %',
          data: {{{data}}},
          backgroundColor: 'rgba(124, 140, 255, 0.7)',
          borderColor: 'rgba(124, 140, 255, 1)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        layout: {
          padding: { top: 10, right: 16, bottom: 8, left: 12 }
        },
        animation: {
          duration: 650,
          easing: 'easeOutQuart'
        },
        elements: {
          bar: {
            borderRadius: 10,
            borderSkipped: false
          },
          point: {
            radius: 0
          }
        },
        plugins: {
          legend: {
            position: 'top',
            labels: {
              usePointStyle: true,
              pointStyle: 'rectRounded',
              boxWidth: 10,
              padding: 16,
              font: { size: 13, weight: '600' },
              color: 'rgba(255,255,255,.78)'
            }
          },
          tooltip: {
            enabled: true,
            backgroundColor: 'rgba(10,16,28,.92)',
            titleColor: 'rgba(255,255,255,.92)',
            bodyColor: 'rgba(255,255,255,.85)',
            padding: 12,
            cornerRadius: 12,
            displayColors: false,
            callbacks: {
              title: (context) => chartLabels[context[0].dataIndex],
              label: (context) => `Completion: ${context.parsed.y}%`
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            max: 100,
            ticks: {
              stepSize: 10,
              padding: 10,
              font: { size: 12, weight: '600' },
              color: 'rgba(255,255,255,.70)',
              callback: (value) => `${value}%`
            },
            grid: {
              color: 'rgba(255,255,255,.06)',
              drawBorder: false
            }
          },
          x: {
            ticks: {
              color: 'rgba(255,255,255,.70)',
              font: { size: 12, weight: '600' },
              padding: 10,
              autoSkip: false,
              maxRotation: 0,
              minRotation: 0,
              callback: (value) => wrapLabel(chartLabels[value])
            },
            grid: {
              display: false,
              drawBorder: false
            }
          }
        }
      }
    });

    document.querySelectorAll('.sparkline').forEach(canvas => {
      const ctx = canvas.getContext('2d');
      const labels = JSON.parse(canvas.dataset.labels);
      const values = JSON.parse(canvas.dataset.values);
      new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'Trend',
            data: values,
            fill: false,
            borderColor: 'rgba(45, 212, 191, 1)',
            tension: 0.3
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: {
            y: { display: false },
            x: { display: false }
          }
        }
      });
    });
  </script>
{{else}}
  <div class="card">
    <p class="card-meta">No log data found. Start tracking your habits.</p>
  </div>
{{/if}}
